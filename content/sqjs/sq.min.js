"use strict";function randBetween(a,b){return Math.random()*(b-a)+a}function randIntBetween(a,b){return Math.floor(Math.random()*(b-a+1))+a}function addShape(a,b,c,d){var c=c||{},e=new b2BodyDef;e.position=b;for(var f in c)"undefined"!=typeof e[f]&&"undefined"!=typeof c[f]&&(e[f]=c[f]);var g=a.CreateBody(e),h=d(),i=new b2FixtureDef;i.shape=h;for(var f in c)"undefined"!=typeof i[f]&&"undefined"!=typeof c[f]&&(i[f]=c[f]);return i.filter.categoryBits="undefined"==typeof c.filterCategory?65535:c.filterCategory,i.filter.maskBits="undefined"==typeof c.filterMask?65535:c.filterMask,i.isSensor=c.sensor||!1,g.CreateFixture(i),g.SetLinearVelocity(c.linearVelocity),g}function addEdgeShape(a,b,c,d){return addShape(a,new b2Vec2((b.x+c.x)/2,(b.y+c.y)/2),d,function(){var a=new b2PolygonShape;return a.SetAsEdge(new b2Vec2(b.x-(b.x+c.x)/2,b.y-(b.y+c.y)/2),new b2Vec2(c.x-(b.x+c.x)/2,c.y-(b.y+c.y)/2)),a})}function addBoxShape(a,b,c,d,e){return addShape(a,b,e,function(){var a=new b2PolygonShape;return a.SetAsBox(c,d),a})}function addCircleShape(a,b,c,d){return addShape(a,b,d,function(){var a=new b2CircleShape;return a.m_radius=c,a})}function distanceSquared(a,b){var c=new b2Vec2(a.x,a.y),d=new b2Vec2(b.x,b.y);return c.Subtract(d),c.LengthSquared()}function randomLocation(a,b,c,d){return new b2Vec2(randBetween(a,b),randBetween(c,d))}function randomLocationAvoidRadius(a,b,c,d,e,f){var g;do g=randomLocation(a,b,c,d);while(distanceSquared(g,e)<=f*f);return g}function rtToVector(a,b){return new b2Vec2(a*Math.cos(b),a*Math.sin(b))}function vectorAngle(a){return Math.atan2(a.y,a.x)}function randomAngle(){return randBetween(-Math.PI,Math.PI)}function rad2deg(a){return 180*(a/Math.PI)}function deg2rad(a){return a/180*Math.PI}function vectorFromTo(a,b,c){var d=new b2Vec2(b.x-a.x,b.y-a.y);return c&&(d.Normalize(),d.Multiply(c)),d}function zeroPad(a,b){var c=Math.abs(a),d=Math.max(0,b-Math.floor(c).toString().length),e=Math.pow(10,d).toString().substr(1);return 0>a&&(e="-"+e),e+c}function createPlayer(){var a=Object.create(SqEntity);return a.init(TYPE_PLAYER,new b2Vec2(0,0),.12,{linearDamping:1.5,destroySound:"sound/playerDestroy.ogg"}),a.invincibleTimer=0,a.isInvincible=function(){return this.invincibleTimer>0},a.stepAction.push(function(){this.invincibleTimer--}),a.revive=function(){this.destroyed=!1,this.invincibleTimer=3*FPS},a.stepAction.push(PlayerBehaviours.moveByWASD),a.stepAction.push(PlayerBehaviours.fireByLeftMouse),a.fireCooldown=3,a.movingForce=.015,a.draw=function(){var a,b,c,d=document.getElementById("game-scene").getContext("2d");a=100*this.body.GetPosition().x+300,b=100*-this.body.GetPosition().y+300,c=100*this.size;var e=this.color.a;this.isInvincible()&&this.invincibleTimer%30<15&&(e=0),d.beginPath(),d.fillStyle="hsla("+this.color.h+", "+100*this.color.s+"%, "+100*this.color.l+"%, "+e+")",d.arc(a,b,c,0,2*Math.PI,!0),d.fill()},a}function createEnemy(a,b,c,d,e,f){c.destroySound=c.destroySound||"sound/destroy.ogg";var g=Object.create(SqEntity);return g.init(TYPE_ENEMY,a,b,c),$.each(d||[],function(){g.stepAction.push(this)}),$.each(e||[],function(){g.onHitAction.push(this)}),$.each(f||[],function(){g.postHitAction.push(this)}),g.draw=function(){var a=document.getElementById("game-scene").getContext("2d"),b=100*this.size;a.save(),a.fillStyle="hsla("+this.color.h+", "+100*this.color.s+"%, "+100*this.color.l+"%, "+this.color.a+")",a.translate(100*this.body.GetPosition().x+300,100*-this.body.GetPosition().y+300),a.rotate(-this.body.GetAngle()),a.fillRect(-b,-b,2*b,2*b),a.restore()},g}function createPowerup(a,b,c,d,e){var f=Object.create(SqEntity);return f.init(TYPE_POWERUP,a,.12,{lifetime:b,destroySound:"sound/powerup.ogg"}),f.timeout=b,f.color=c,f.powerup=e,f.puType=d,f.draw=function(){var a=document.getElementById("game-scene").getContext("2d"),b=100*this.body.GetPosition().x+300,c=100*-this.body.GetPosition().y+300,d=100*this.size;a.beginPath(),a.strokeStyle="hsla("+this.color.h+", "+100*this.color.s+"%, "+100*this.color.l+"%, "+this.color.a+")",a.arc(b,c,d,0,2*Math.PI,!0),a.stroke()},f}function generateWave(a,b,c,d){0==b?a.pushMul(3,simple()):a=d}function enemyStoreStat(a,b,c,d){var e="sq_enemy_type_kill_count",f=JSON.parse(localStorage.getItem(e))||{};$.each(d,function(){f[this.name]||(f[this.name]=0),f[this.name]+=this.kills}),localStorage.setItem(e,JSON.stringify(f))}function generateWave(a,b,c){var d=function(){return randomLocationAvoidRadius(-2.6,2.6,-2.6,2.6,c.body.GetPosition(),1)},e=function(a){var b=createEnemy(a?a.body.GetPosition():d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:0,s:1,l:.5,a:1},scoreOnDestroy:a?0:1,name:"simple"},[Behaviours.alignRotationToMovement]);return b},f=function(a){var b=createEnemy(a?a.body.GetPosition():d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:10,s:1,l:.5,a:1},scoreOnDestroy:a?0:1,name:"chasing"},[Behaviours.alignRotationToMovement,Behaviours.chasePlayer]);return b.chaseFactor=.02,b},g=function(a){var b=createEnemy(a?a.body.GetPosition():d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:20,s:1,l:.5,a:1},scoreOnDestroy:a?0:1,name:"randomFiring"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return b.fireCooldown=100,b.bulletSpeed=5,b.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},b},h=function(a){var b=createEnemy(a?a.body.GetPosition():d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:30,s:1,l:.5,a:1},scoreOnDestroy:a?0:1,name:"aimedFiring"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire]);return b.fireCooldown=100,b.aimError=deg2rad(10),b.bulletSpeed=5,b.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},b},i=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:0,s:1,l:.55,a:1},name:"hp"},[Behaviours.alignRotationToMovement],[Behaviours.hp]);return a.hp=3,a},j=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:30,s:1,l:.55,a:1},name:"hpAimedFiring"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire],[Behaviours.hp]);return a.fireCooldown=100,a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a.hp=3,a},k=function(){var a=createEnemy(d(),.4,{linearVelocity:rtToVector(3,randomAngle()),color:{h:0,s:1,l:.6,a:1},name:"large"},[Behaviours.alignRotationToMovement],[Behaviours.hp]);return a.hp=5,a},l=function(){var a=createEnemy(d(),.04,{linearVelocity:rtToVector(3,randomAngle()),color:{h:0,s:1,l:.45,a:1},name:"small"},[Behaviours.alignRotationToMovement]);return a},m=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(6,randomAngle()),color:{h:0,s:.9,l:.5,a:1},name:"fast"},[Behaviours.alignRotationToMovement]);return a},n=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:40,s:1,l:.5,a:1},name:"counterAttack"},[Behaviours.alignRotationToMovement],[],[Behaviours.counterAttack]);return a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:100,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement],[Behaviours.indestructible])},a},o=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:50,s:1,l:.5,a:1},name:"chaseFiring"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire,Behaviours.chasePlayer]);return a.chaseFactor=.03,a.fireCooldown=100,a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},p=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:10,s:1,l:.55,a:1},name:"hpChasing"},[Behaviours.alignRotationToMovement,Behaviours.chasePlayer],[Behaviours.hp]);return a.chaseFactor=.05,a.hp=3,a},q=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:60,s:1,l:.55,a:1},name:"teleporting"},[Behaviours.alignRotationToMovement],[Behaviours.hp],[Behaviours.teleport]);return a.hp=3,a},r=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:40,s:1,l:.55,a:1},name:"hpCounterAttack"},[Behaviours.alignRotationToMovement],[Behaviours.hp],[Behaviours.counterAttack]);return a.hp=5,a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:100,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},s=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:70,s:1,l:.5,a:1},name:"blinking"},[Behaviours.alignRotationToMovement,Behaviours.blink],[Behaviours.hp]);return a.hp=3,a.blinkOn=60,a.blinkOff=60,a},t=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:70,s:.9,l:.5,a:1},name:"blinkingCounterAttack"},[Behaviours.alignRotationToMovement,Behaviours.blink],[Behaviours.hpImmuneWhenBlink],[Behaviours.counterAttackOnBlink]);return a.hp=1,a.blinkOn=60,a.blinkOff=60,a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.oldColor,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},u=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:20,s:.9,l:.5,a:1},name:"frequentRandomFiring"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return a.fireCooldown=40,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},v=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:20,s:.8,l:.5,a:1},name:"randomFiring3"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return a.fireCooldown=100,a.bulletSpeed=5,a.bulletSpread=3,a.bulletSpreadAngle=deg2rad(10),a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},w=function(){var a=createEnemy(d(),.04,{linearVelocity:rtToVector(3,randomAngle()),color:{h:10,s:1,l:.45,a:1},name:"smallChasing"},[Behaviours.alignRotationToMovement,Behaviours.chasePlayer]);return a.chaseFactor=.06,a},x=function(){var a=createEnemy(d(),.4,{linearVelocity:rtToVector(3,randomAngle()),color:{h:30,s:1,l:.7,a:1},name:"largeFiring"},[Behaviours.alignRotationToMovement,Behaviours.randomFire],[Behaviours.hp]);return a.fireCooldown=100,a.bulletSpeed=5,a.hp=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.12,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},y=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:80,s:1,l:.5,a:1},name:"mineLayer"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return a.fireCooldown=50,a.bulletSpeed=0,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:-1,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},z=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:30,s:.8,l:.5,a:1},name:"indestructibleFiring"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire]);return a.fireCooldown=100,a.bulletSpeed=5,a.aimError=0,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:100,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement],[Behaviours.indestructible])},a},A=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:90,s:1,l:.5,a:1},name:"bulletAttractor"},[Behaviours.alignRotationToMovement,Behaviours.attractBullet],[Behaviours.hp]);return a.hp=10,a.attractingForce=.001,a},B=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:100,s:1,l:.5,a:1},name:"bulletRepulsor"},[Behaviours.alignRotationToMovement,Behaviours.repelBullet]);return a.repellingForce=.001,a},C=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:110,s:1,l:.5,a:1},name:"generator"},[Behaviours.alignRotationToMovement,Behaviours.randomFire],[Behaviours.hp]);return a.fireCooldown=100,a.bulletSpeed=3,a.hp=5,a.createBullet=e,a},D=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(2,randomAngle()),color:{h:120,s:1,l:.5,a:1},name:"sneaky"},[Behaviours.alignRotationToMovement,Behaviours.sneaky,Behaviours.chasePlayer],[Behaviours.hpImmuneWhenBlink]);return a.hp=1,a.sneakyRange=1.5,a.chaseFactor=.05,a},E=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:80,s:1,l:.6,a:1},name:"sneakyMineLayer"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return a.fireCooldown=50,a.bulletSpeed=0,a.playSound=null,a.createBullet=function(a,b){var c=createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:$.extend({},a.color),scoreOnDestroy:0,lifetime:-1,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement,Behaviours.sneaky]);return c.hp=1,c.sneakyRange=1,c},a},F=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(6,randomAngle()),color:{h:20,s:.7,l:.5,a:1},name:"fastRandomFiring"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return a.fireCooldown=40,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},G=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:30,s:.8,l:.6,a:1},name:"hpAimedFiring3"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire],[Behaviours.hp]);return a.fireCooldown=100,a.bulletSpeed=5,a.bulletSpread=3,a.hp=5,a.bulletSpreadAngle=deg2rad(10),a.aimError=0,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},H=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:130,s:1,l:.5,a:1},name:"fireChasing"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return a.fireCooldown=50,a.bulletSpeed=5,a.createBullet=function(a,b){var c=createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement,Behaviours.chasePlayer]);return c.chaseFactor=.05,c},a},I=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:20,s:1,l:.1,a:1},name:"darkFiring"},[Behaviours.alignRotationToMovement,Behaviours.randomFire]);return a.fireCooldown=40,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},J=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:60,s:1,l:.7,a:1},name:"autoTeleporting"},[Behaviours.alignRotationToMovement,Behaviours.autoTeleport],[Behaviours.hp,Behaviours.teleport]);return a.teleportCooldown=50,a.hp=7,a.playSound="sound/teleport.ogg",a},K=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:20,s:.9,l:.4,a:1},name:"splitRandomFiring"},[Behaviours.alignRotationToMovement,Behaviours.randomFire],[],[Behaviours.split]);return a.fireCooldown=33,a.bulletSpeed=5,a.splitCount=9,a.splitTo=g,a.splitSpeed=3,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},L=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:40,s:.9,l:.5,a:1},name:"burstOnHit"},[Behaviours.alignRotationToMovement],[],[Behaviours.counterAttack]);return a.aimError=0,a.bulletSpeed=5,a.bulletSpread=30,a.bulletSpreadAngle=deg2rad(12),a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},M=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:40,s:.9,l:.55,a:1},name:"hpIndestructibleCounterAttack"},[Behaviours.alignRotationToMovement],[Behaviours.hp],[Behaviours.counterAttack]);return a.aimError=0,a.bulletSpeed=5,a.bulletSpread=3,a.bulletSpreadAngle=deg2rad(10),a.hp=3,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement],[Behaviours.indestructible])},a},N=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(6,randomAngle()),color:{h:20,s:.6,l:.5,a:1},name:"hpFastAimedFiring"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire],[Behaviours.hp]);return a.aimError=deg2rad(10),a.hp=5,a.fireCooldown=100,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},O=function(){var a=createEnemy(d(),.04,{linearVelocity:rtToVector(3,randomAngle()),color:{h:10,s:.9,l:.4,a:1},name:"hpSmallChasing"},[Behaviours.alignRotationToMovement,Behaviours.chasePlayer],[Behaviours.hp]);return a.hp=5,a.chaseFactor=.06,a},P=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:140,s:1,l:.5,a:1},scoreOnDestroy:parent?0:1,name:"moveForceToPlayer"},[Behaviours.alignRotationToMovement,Behaviours.forceToPlayer],[Behaviours.hp]);return a.hp=3,a.toPlayerForce=.01,a},Q=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:110,s:.9,l:.5,a:1},name:"chaserGenerator"},[Behaviours.alignRotationToMovement,Behaviours.randomFire],[Behaviours.hp]);return a.fireCooldown=100,a.bulletSpeed=3,a.hp=8,a.createBullet=f,a},R=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:150,s:1,l:.7,a:1},name:"immuneTarget"},[Behaviours.alignRotationToMovement],[Behaviours.hp]);return a.hp=8,a},S=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:150,s:1,l:.5,a:1},scoreOnDestroy:parent?0:1,name:"immuneUntilTargetBeaten"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire],[Behaviours.immuneUntilTargetBeaten]);return a.targetName="immuneTarget",a.fireCooldown=50,a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},T=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:160,s:1,l:.5,a:1},scoreOnDestroy:parent?0:1,name:"burstBullet"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire],[Behaviours.hp]);return a.fireCooldown=50,a.aimError=0,a.bulletSpeed=3,a.hp=5,a.createBullet=function(a,b){var c=createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement],[],[Behaviours.counterAttack]);return c.aimError=0,c.bulletSpeed=5,c.bulletSpread=12,c.bulletSpreadAngle=deg2rad(30),c.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},c},a},U=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:170,s:1,l:.5,a:1},name:"attractCounterAttack"},[Behaviours.alignRotationToMovement,Behaviours.attractBullet],[Behaviours.hp],[Behaviours.counterAttack]);return a.hp=30,a.attractingForce=.001,a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:100,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},V=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:180,s:1,l:.5,a:1},name:"repelAimedFiring"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire,Behaviours.repelBullet],[Behaviours.hp]);return a.repellingForce=.001,a.fireCooldown=100,a.bulletSpeed=5,a.bulletSpread=3,a.hp=3,a.bulletSpreadAngle=deg2rad(10),a.aimError=0,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},W=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:190,s:1,l:.5,a:1},scoreOnDestroy:parent?0:1,name:"speedyEscape"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire]);return a.fireCooldown=33,a.aimError=0,a.bulletSpeed=5,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:a.color,scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},X=function(){var a=createEnemy(d(),.12,{linearVelocity:rtToVector(3,randomAngle()),color:{h:200,s:1,l:.5,a:0},name:"transparentFiring"},[Behaviours.alignRotationToMovement,Behaviours.aimedFire],[Behaviours.hp]);return a.transparentTime=1e3,a.fireCooldown=100,a.bulletSpeed=5,a.bulletSpread=3,a.hp=3,a.bulletSpreadAngle=deg2rad(10),a.aimError=0,a.createBullet=function(a,b){return createEnemy(a.body.GetPosition(),.06,{linearVelocity:b,color:{h:200,s:1,l:.5,a:1},scoreOnDestroy:0,lifetime:60,preventNextWave:!1,generateParticles:!1,destroySound:"sound/bulletDestroy.ogg"},[Behaviours.alignRotationToMovement])},a},Y=[];return Y[0]=[].pushMul(3,e),Y[1]=[].pushMul(2,e).pushMul(2,f),Y[2]=[].pushMul(3,g),Y[3]=[].pushMul(2,e).pushMul(2,f).pushMul(2,g),Y[4]=[].pushMul(4,h),Y[5]=[].pushMul(2,f).pushMul(2,g).pushMul(2,h),Y[6]=[].pushMul(5,i),Y[7]=[].pushMul(3,i).pushMul(3,f).pushMul(2,h),Y[8]=[].pushMul(5,j),Y[9]=[].pushMul(3,j).pushMul(4,g),Y[10]=[].pushMul(3,k).pushMul(3,l),Y[11]=[].pushMul(3,m).pushMul(2,k).pushMul(2,l),Y[12]=[].pushMul(3,m).pushMul(3,l).pushMul(3,f),Y[13]=[].pushMul(3,k).pushMul(2,i).pushMul(3,j),Y[14]=[].pushMul(5,n),Y[15]=[].pushMul(3,n).pushMul(3,f).pushMul(2,j),Y[16]=[].pushMul(5,o),Y[17]=[].pushMul(5,p),Y[18]=[].pushMul(4,o).pushMul(4,p),Y[19]=[].pushMul(3,p).pushMul(3,n).pushMul(3,o).pushMul(3,l),Y[20]=[].pushMul(6,q),Y[21]=[].pushMul(5,r),Y[22]=[].pushMul(5,q).pushMul(3,r),Y[23]=[].pushMul(3,r).pushMul(3,n).pushMul(3,l),Y[24]=[].pushMul(5,k).pushMul(5,q),Y[25]=[].pushMul(8,s),Y[26]=[].pushMul(5,t).pushMul(3,s),Y[27]=[].pushMul(5,r).pushMul(5,t),Y[28]=[].pushMul(5,u).pushMul(3,o),Y[29]=[].pushMul(5,v).pushMul(3,j),Y[30]=[].pushMul(5,v).pushMul(5,u),Y[31]=[].pushMul(10,w),Y[32]=[].pushMul(5,x).pushMul(3,j),Y[33]=[].pushMul(6,y).pushMul(4,s),Y[34]=[].pushMul(5,y).pushMul(5,w),Y[35]=[].pushMul(5,z).pushMul(5,r),Y[36]=[].pushMul(4,z).pushMul(4,w).pushMul(4,u),Y[37]=[].pushMul(6,w).pushMul(6,s),Y[38]=[].pushMul(8,y).pushMul(4,u).pushMul(4,v),Y[39]=[].pushMul(3,w).pushMul(3,o).pushMul(3,p).pushMul(3,s).pushMul(3,t).pushMul(3,r),Y[40]=[].pushMul(8,A),Y[41]=[].pushMul(8,B),Y[42]=[].pushMul(4,B).pushMul(6,p),Y[43]=[].pushMul(2,A).pushMul(2,B).pushMul(6,j),Y[44]=[].pushMul(4,A).pushMul(3,r).pushMul(3,t),Y[45]=[].pushMul(5,C),Y[46]=[].pushMul(3,C).pushMul(6,x),Y[47]=[].pushMul(5,A).pushMul(5,C),Y[48]=[].pushMul(8,D),Y[49]=[].pushMul(4,D).pushMul(4,v).pushMul(4,u),Y[50]=[].pushMul(5,D).pushMul(5,r),Y[51]=[].pushMul(8,E),Y[52]=[].pushMul(3,E).pushMul(2,C).pushMul(5,w),Y[53]=[].pushMul(5,D).pushMul(5,A),Y[54]=[].pushMul(3,D).pushMul(3,E).pushMul(3,t).pushMul(3,z),Y[55]=[].pushMul(4,F).pushMul(4,G),Y[56]=[].pushMul(5,F).pushMul(5,r).pushMul(2,B),Y[57]=[].pushMul(6,z).pushMul(3,G).pushMul(3,x),Y[58]=[].pushMul(5,p).pushMul(5,F).pushMul(5,w),Y[59]=[].pushMul(3,C).pushMul(3,A).pushMul(3,B).pushMul(3,F).pushMul(3,G).pushMul(5,D),Y[60]=[].pushMul(10,I),Y[61]=[].pushMul(7,I).pushMul(5,D),Y[62]=[].pushMul(7,H),Y[63]=[].pushMul(5,H).pushMul(2,C).pushMul(2,E),Y[64]=[].pushMul(12,J),Y[65]=[].pushMul(6,J).pushMul(3,z).pushMul(3,w),Y[66]=[].pushMul(8,M),Y[67]=[].pushMul(4,M).pushMul(4,I).pushMul(4,H),Y[68]=[].pushMul(6,J).pushMul(4,M).pushMul(2,C).pushMul(2,G),Y[69]=[].pushMul(6,K),Y[70]=[].pushMul(3,K).pushMul(3,J).pushMul(3,H),Y[71]=[].pushMul(8,L),Y[72]=[].pushMul(8,N),Y[73]=[].pushMul(12,O),Y[74]=[].pushMul(5,N).pushMul(5,O),Y[75]=[].pushMul(3,A).pushMul(3,L).pushMul(3,G).pushMul(6,O),Y[76]=[].pushMul(3,B).pushMul(6,L).pushMul(6,N),Y[77]=[].pushMul(5,P),Y[78]=[].pushMul(3,P).pushMul(6,O).pushMul(3,N).pushMul(3,I),Y[79]=[].pushMul(6,H).pushMul(3,P).pushMul(6,L).pushMul(3,M).pushMul(3,K),Y[80]=[].pushMul(6,Q),Y[82]=[].pushMul(4,Q).pushMul(4,K),Y[81]=[].pushMul(4,Q).pushMul(6,O).pushMul(2,E),Y[83]=[].pushMul(12,R).pushMul(3,S),Y[84]=[].pushMul(5,R).pushMul(2,S).pushMul(4,Q).pushMul(2,J),Y[85]=[].pushMul(8,T),Y[86]=[].pushMul(3,T).pushMul(5,R).pushMul(1,S).pushMul(3,M),Y[87]=[].pushMul(10,U),Y[88]=[].pushMul(10,V),Y[89]=[].pushMul(5,V).pushMul(3,D).pushMul(3,M),Y[90]=[].pushMul(5,U).pushMul(5,J),Y[91]=[].pushMul(3,U).pushMul(3,V).pushMul(3,Q),Y[92]=[].pushMul(12,W),Y[93]=[].pushMul(6,W).pushMul(3,M).pushMul(3,T),Y[94]=[].pushMul(12,X),Y[95]=[].pushMul(4,X).pushMul(6,I).pushMul(8,D),Y[96]=[].pushMul(4,W).pushMul(4,X).pushMul(4,M),Y[97]=[].pushMul(5,Q).pushMul(8,R).pushMul(3,S).pushMul(4,x),Y[98]=[].pushMul(5,U).pushMul(5,W).pushMul(5,T).pushMul(3,N),Y[99]=[].pushMul(3,Q).pushMul(3,T).pushMul(3,R).pushMul(3,S).pushMul(3,U).pushMul(3,V).pushMul(3,X).pushMul(3,W),$.each(Y[(b-1)%Y.length],function(){for(var c=0;c<Math.ceil(b/Y.length);c++)a.push(this())}),a}var AudioPlayer=function(){return $(function(){$("audio").on("ended",function(){$(this).addClass("ended")})}),{play:function(a){if(a){var b=a.replace(/[^a-zA-Z]/g,""),c=$("audio.ended."+b);c.length>0?$(c[0]).removeClass("ended")[0].play():$("<audio>").prop("src",a).prop("autoplay","true").prop("class",b).appendTo("body").on("ended",function(){$(this).addClass("ended")})}}}}(),Behaviours=function(){function a(a){var b=this;$.each(a,function(){if("undefined"==typeof b[this])throw this+" is required."})}return{alignRotationToMovement:function(){this.body.SetAngle(vectorAngle(this.body.GetLinearVelocity()))},chasePlayer:function(b,c,d){if(a.call(this,["chaseFactor"]),!d.destroyed){var e,f,g=this.body.GetAngle(),h=vectorAngle(vectorFromTo(this.body.GetPosition(),d.body.GetPosition())),e=Math.abs(h-g);h>g?f=e>Math.PI?-1:1:g>h&&(f=e>Math.PI?1:-1);var i=this.body.GetLinearVelocity().Length();e<this.chaseFactor?this.body.SetLinearVelocity(rtToVector(i,h)):this.body.SetLinearVelocity(rtToVector(i,g+this.chaseFactor*f))}},randomFire:function(b,c,d,e,f){if(a.call(this,["fireCooldown","bulletSpeed","createBullet"]),"undefined"==typeof this.fireCooldownTimer&&(this.fireCooldownTimer=randBetween(0,this.fireCooldown)),this.bulletSpread=this.bulletSpread||1,this.bulletSpreadAngle=this.bulletSpreadAngle||0,this.playSound="undefined"==typeof this.playSound?"sound/fire.ogg":this.playSound,this.fireCooldownTimer<=0){this.fireCooldownTimer=this.fireCooldown;for(var g=randomAngle(),h=-this.bulletSpread/2+.5;h<this.bulletSpread/2+.5;h+=1){var i=rtToVector(this.bulletSpeed,g+h*this.bulletSpreadAngle),j=this.createBullet(this,i);j.parent=this,f.push(j)}AudioPlayer.play(this.playSound)}this.fireCooldownTimer--},aimedFire:function(b,c,d,e,f){if(a.call(this,["fireCooldown","bulletSpeed","createBullet","aimError"]),"undefined"==typeof this.fireCooldownTimer&&(this.fireCooldownTimer=randBetween(0,this.fireCooldown)),this.bulletSpread=this.bulletSpread||1,this.bulletSpreadAngle=this.bulletSpreadAngle||0,this.playSound="undefined"==typeof this.playSound?"sound/fire.ogg":this.playSound,this.fireCooldownTimer<=0){if(this.fireCooldownTimer=this.fireCooldown,d.destroyed)var g=randomAngle();else var g=vectorAngle(vectorFromTo(this.body.GetPosition(),d.body.GetPosition()))+randBetween(-this.aimError,this.aimError);for(var h=-this.bulletSpread/2+.5;h<this.bulletSpread/2+.5;h+=1){var i=rtToVector(this.bulletSpeed,g+h*this.bulletSpreadAngle),j=this.createBullet(this,i);j.parent=this,f.push(j)}AudioPlayer.play(this.playSound)}this.fireCooldownTimer--},hp:function(){return a.call(this,["hp"]),"undefined"==typeof this.currentHp&&(this.currentHp=this.hp),this.playSound="undefined"==typeof this.playSound?"sound/hit.ogg":this.playSound,this.currentHp--,this.currentHp>0&&AudioPlayer.play(this.playSound),this.currentHp>0},indestructible:function(){return!0},counterAttack:function(b,c,d,e,f){a.call(this,["bulletSpeed","createBullet","aimError"]),this.bulletSpread=this.bulletSpread||1,this.bulletSpreadAngle=this.bulletSpreadAngle||0,this.playSound="undefined"==typeof this.playSound?"sound/fire.ogg":this.playSound;var g=rtToVector(this.bulletSpeed,vectorAngle(vectorFromTo(this.body.GetPosition(),d.body.GetPosition()))+randBetween(-this.aimError,this.aimError));if(d.destroyed)var h=randomAngle();else var h=vectorAngle(vectorFromTo(this.body.GetPosition(),d.body.GetPosition()))+randBetween(-this.aimError,this.aimError);for(var i=-this.bulletSpread/2+.5;i<this.bulletSpread/2+.5;i+=1){var g=rtToVector(this.bulletSpeed,h+i*this.bulletSpreadAngle),j=this.createBullet(this,g);j.parent=this,f.push(j)}f.push(j),AudioPlayer.play(this.playSound)},teleport:function(a,b,c){this.body.SetPosition(randomLocationAvoidRadius(-2.6,2.6,-2.6,2.6,c.body.GetPosition(),1)),AudioPlayer.play("sound/teleport.ogg")},blink:function(b,c,d,e,f){a.call(this,["blinkOn","blinkOff"]),this.blinkAction=this.blinkAction||[],"undefined"==typeof this.blinkTimer&&(this.blinkTimer=randBetween(0,this.blinkOn)),"undefined"==typeof this.oldColor&&(this.oldColor=$.extend({},this.color)),"undefined"==typeof this.blinking&&(this.blinking=!1),this.blinkTimer<=0&&(this.blinking=!this.blinking,this.color.a=this.blinking?0:this.oldColor.a,this.blinkTimer=this.blinking?this.blinkOff:this.blinkOn);
for(var g=0;g<this.blinkAction.length;++g)this.blinkAction[g].call(this,b,c,d,e,f);this.blinkTimer--},counterAttackOnBlink:function(b,c,d,e,f){if("undefined"!=typeof this.blinking&&this.blinking){a.call(this,["bulletSpeed","createBullet","aimError"]),this.playSound="undefined"==typeof this.playSound?"sound/fire.ogg":this.playSound;var g=rtToVector(this.bulletSpeed,vectorAngle(vectorFromTo(this.body.GetPosition(),d.body.GetPosition()))+randBetween(-this.aimError,this.aimError)),h=this.createBullet(this,g);h.parent=this,f.push(h),AudioPlayer.play(this.playSound)}},hpImmuneWhenBlink:function(){return a.call(this,["hp"]),"undefined"!=typeof this.blinking?("undefined"==typeof this.currentHp&&(this.currentHp=this.hp),this.blinking||this.currentHp--,this.currentHp>0):void 0},sneaky:function(b,c,d){a.call(this,["sneakyRange"]),"undefined"==typeof this.oldColor&&(this.oldColor=$.extend({},this.color)),"undefined"==typeof this.blinking&&(this.blinking=!1),!d.destroyed&&distanceSquared(this.body.GetPosition(),d.body.GetPosition())<this.sneakyRange*this.sneakyRange?(this.blinking=!1,this.color.a=this.oldColor.a):(this.blinking=!0,this.color.a=0)},attractBullet:function(b,c,d,e){a.call(this,["attractingForce"]);var f=this;$.each(e,function(){var a=vectorFromTo(this.body.GetPosition(),f.body.GetPosition(),f.attractingForce);this.body.ApplyImpulse(a,this.body.GetWorldCenter())})},repelBullet:function(b,c,d,e){a.call(this,["repellingForce"]);var f=this;$.each(e,function(){var a=vectorFromTo(f.body.GetPosition(),this.body.GetPosition(),f.repellingForce);this.body.ApplyImpulse(a,this.body.GetWorldCenter())})},autoTeleport:function(b,c,d){a.call(this,["teleportCooldown"]),"undefined"==typeof this.teleportTimer&&(this.teleportTimer=randBetween(0,this.teleportCooldown)),this.playSound="undefined"==typeof this.playSound?"sound/fire.ogg":this.playSound,this.teleportTimer<=0&&(this.teleportTimer=this.teleportCooldown,this.body.SetPosition(randomLocationAvoidRadius(-2.6,2.6,-2.6,2.6,d.body.GetPosition(),1)),AudioPlayer.play(this.playSound)),this.teleportTimer--},split:function(b,c,d,e,f){a.call(this,["splitCount","splitTo"]);for(var g=0;g<this.splitCount;++g){var h=this.splitTo(this);f.push(h)}},forceToPlayer:function(b,c,d){a.call(this,["toPlayerForce"]);var e=vectorFromTo(this.body.GetPosition(),d.body.GetPosition(),this.toPlayerForce);this.body.ApplyImpulse(e,this.body.GetWorldCenter())},immuneUntilTargetBeaten:function(b,c,d,e,f){a.call(this,["targetName"]);var g=this,h=!1;return $.each(f,function(){return this.name==g.targetName?(h=!0,!1):void 0}),h}}}(),b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2ContactListener=Box2D.Dynamics.b2ContactListener;Array.prototype.pushMul=function(a,b){for(var c=0;a>c;++c)this.push(b);return this};var TYPE_PLAYER=0,TYPE_ENEMY=1,TYPE_PLAYER_BULLET=2,TYPE_POWERUP=3,SqEntity=function(){var a=0;return{init:function(b,c,d,e){e=e||{};var f;switch(b){case TYPE_PLAYER:f=10;break;case TYPE_ENEMY:f=5;break;case TYPE_PLAYER_BULLET:f=2;break;case TYPE_POWERUP:f=1}var g={type:b2Body.b2_dynamicBody,linearDamping:e.linearDamping||0,fixedRotation:!0,density:1,restitution:0,friction:0,filterCategory:1<<b,filterMask:f,linearVelocity:e.linearVelocity||new b2Vec2(0,0)};this.body=b===TYPE_ENEMY?addBoxShape(world,c,d,d,g):addCircleShape(world,c,d,g),this.body.SetUserData(this),this.type=b,this.id=a,this.lifetime=e.lifetime||-1,this.size=d,this.color=e.color||(b===TYPE_ENEMY?{h:0,s:1,l:.5,a:1}:{h:0,s:0,l:.75,a:1}),this.scoreOnDestroy="undefined"==typeof e.scoreOnDestroy?this.lifetime<=0?1:0:e.scoreOnDestroy,this.preventNextWave="undefined"==typeof e.preventNextWave?b===TYPE_ENEMY:e.preventNextWave,this.destroySound=e.destroySound,this.generateParticles="undefined"==typeof e.generateParticles?!0:e.generateParticles,this.kills=0,this.parent=null,this.name=e.name||"",this.stepAction=[],this.onHitAction=[],this.postHitAction=[],this.lifetimeTimer=this.lifetime,this.justHit=!1,this.destroyed=!1,a++},step:function(a,b,c,d,e){for(var f=0;f<this.stepAction.length;++f)this.stepAction[f].call(this,a,b,c,d,e);this.lifetimeTimer--,this.lifetimeTimer<=0&&this.lifetime>0&&this.destroy(!1)},destroy:function(a){this.destroyed=!0,a&&"undefined"!=typeof this.destroySound&&AudioPlayer.play(this.destroySound)},isDestroyed:function(){return this.destroyed}}}(),HiScore=function(){var a="sq_hiscore",b=function(){var a=new Date;return a.getDate()+"-"+(a.getMonth()+1)+"-"+a.getFullYear()+" "+zeroPad(a.getHours(),2)+":"+zeroPad(a.getMinutes(),2)},c=function(){return[{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0},{time:"1-1-2000 00:00",wave:0,score:0}]},d=null;return{loadHiScore:function(){var b=localStorage.getItem(a);return b=JSON.parse(b)},saveHiScore:function(d,e){var f=localStorage.getItem(a);f=JSON.parse(f),null===f&&(f=c());var g;return $(f).each(function(a){return e>=this.score?(g=a,f.splice(a,0,{time:b(),wave:d,score:e}),f.splice(10,1),!1):void 0}),localStorage.setItem(a,JSON.stringify(f)),g},clearHiScore:function(){d=localStorage.getItem(a),localStorage.removeItem(a)},undoClearHiScore:function(){localStorage.setItem(a,d)},showHiScore:function(a){var b=$(".hiscore-table"),d=function(){var d=HiScore.loadHiScore();null===d&&(d=c(),HiScore.saveHiScore(-1,-1)),b.empty().append("<tr><th>Rank</th><th>Date</th><th>Wave</th><th>Score</th></tr>"),$.each(d,function(c){b.append('<tr class="'+(c===a?"this-hiscore":"")+'"><td>'+(c+1)+"</td><td>"+this.time+"</td><td>"+this.wave+"</td><td>"+this.score+"</td></tr>")})};d(),$(".scene").hide(),$("#hiscore-scene").show(),$("#hiscore-scene .back").one("click",function(){$("#hiscore-scene").hide(),$("#start-scene").show()}),$("#hiscore-scene .clear").one("click",function e(){HiScore.clearHiScore(),d(),$("#hiscore-scene .clear").text("Undo").removeClass("clear").addClass("undo").one("click",function(){HiScore.undoClearHiScore(),d(),$("#hiscore-scene .undo").text("Clear").removeClass("undo").addClass("clear").one("click",e)})})}}}(),PlayerBehaviours=function(){function a(a,b){var c=Object.create(SqEntity);return c.init(TYPE_PLAYER_BULLET,new b2Vec2(a.body.GetPosition().x,a.body.GetPosition().y),.06,{lifetime:60,linearVelocity:b,generateParticles:!1}),c.draw=function(){var a,b,c,d=document.getElementById("game-scene").getContext("2d");a=100*this.body.GetPosition().x+300,b=100*-this.body.GetPosition().y+300,c=100*this.size;var e=this.color.a;d.beginPath(),d.fillStyle="hsla("+this.color.h+", "+100*this.color.s+"%, "+100*this.color.l+"%, "+e+")",d.arc(a,b,c,0,2*Math.PI,!0),d.fill()},c}return{moveByWASD:function(a){if("undefined"==typeof this.movingForce)throw new"movingForce is required";var b=this.body,c=this.movingForce;for(var d in a)switch(d){case"38":case"87":b.ApplyImpulse(new b2Vec2(0,c),b.GetWorldCenter());break;case"37":case"65":b.ApplyImpulse(new b2Vec2(-c,0),b.GetWorldCenter());break;case"40":case"83":b.ApplyImpulse(new b2Vec2(0,-c),b.GetWorldCenter());break;case"39":case"68":b.ApplyImpulse(new b2Vec2(c,0),b.GetWorldCenter())}},fireByLeftMouse:function(b,c,d,e){if("undefined"==typeof this.fireCooldown)throw new"fireCooldown is required";if("undefined"==typeof this.fireCooldownTimer&&(this.fireCooldownTimer=0),c[1]&&this.fireCooldownTimer<=0){this.fireCooldownTimer=this.fireCooldown;var f=c.position,g=vectorFromTo(d.body.GetPosition(),f,5),h=a(d,g);h.parent=this,e.push(h),AudioPlayer.play("sound/playerFire.ogg")}this.fireCooldownTimer--}}}(),world,FPS=60,DEBUG_WAVE=!1;!function(){function a(){if(!I&&J){i(),j(),world.Step(1/FPS,3,2);var a=document.getElementById("game-scene").getContext("2d");a.clearRect(0,0,600,600),a.font='200px "Century Gothic", CenturyGothic, AppleGothic, sans-serif',a.textAlign="center",a.textBaseline="middle",a.fillStyle="hsl(0, 0%, 40%)",a.fillText(D,300,300),o.isDestroyed()?M||(d(o,!0),M=!0):(o.step(K,L,o,v,w),o.draw(),M=!1);for(var b=0;b<v.length;++b){if(v[b].justHit){for(var c=0;c<v[b].postHitAction.length;++c)v[b].postHitAction[c].call(v[b],K,L,o,v,w);v[b].justHit=!1}v[b].isDestroyed()?(world.DestroyBody(v[b].body),v.splice(b--,1)):(v[b].step(K,L,o,v,w),v[b].draw())}for(var b=0;b<w.length;++b){if(w[b].justHit){for(var c=0;c<w[b].postHitAction.length;++c)w[b].postHitAction[c].call(w[b],K,L,o,v,w);w[b].justHit=!1}w[b].isDestroyed()?(w[b].generateParticles&&d(w[b]),world.DestroyBody(w[b].body),w.splice(b--,1)):(w[b].step(K,L,o,v,w),w[b].draw())}for(var b=0;b<y.length;++b)y[b].isDestroyed()?(world.DestroyBody(y[b].body),y.splice(b--,1)):(y[b].step(K,L,o,v,w),y[b].draw());for(var b=0;b<z.length;++b)if(z[b].lifetime--,z[b].lifetime<=0)world.DestroyBody(z[b]),z.splice(b--,1);else{var e=z[b].GetAngle(),f=z[b].GetPosition(),g=new b2Vec2(f.x,f.y);g.Add(rtToVector(z[b].length/2,e));var h=new b2Vec2(f.x,f.y);h.Add(rtToVector(z[b].length/2,e+Math.PI)),a.beginPath(),a.strokeStyle="hsla("+z[b].color.h+", "+100*z[b].color.s+"%, "+100*z[b].color.l+"%, 1.0)",a.moveTo(100*g.x+300,100*-g.y+300),a.lineTo(100*h.x+300,100*-h.y+300),a.lineWidth=2,a.stroke(),a.lineWidth=1}a.font='24px "Century Gothic", CenturyGothic, AppleGothic, sans-serif',a.textAlign="left",a.textBaseline="top",a.fillStyle="hsl(0, 0%, 100%)",a.fillText("Lives: "+B,0,0),a.textAlign="right",a.fillText("Score: "+C,600,0)}}function b(){J&&(requestAnimFrame(b),a(),c())}function c(){for(var a=0;a<A.length;++a)if(A[a].lifetime--,A[a].lifetime<=0)A.splice(a--,1);else for(var b=randBetween(4,6),c=0;b>c;++c){var d=randomAngle(),e=randBetween(.05,.2),f=A[a].position;f.Add(new b2Vec2(randBetween(-.02,.02),randBetween(-.02,.02)));var g=new b2Vec2(f.x,f.y);g.Add(rtToVector(e,d));var h=addEdgeShape(world,f,g,{type:b2Body.b2_kinematicBody,linearDamping:0,filterCategory:0,filterMask:0,linearVelocity:rtToVector(5,d),angle:d,fixedRotation:!0});h.length=e,h.color=A[a].isPlayer?{h:randBetween(0,360),s:1,l:.5,a:1}:A[a].color,h.lifetime=randBetween(20,30),z.push(h)}}function d(a,b){A.push({position:a.body.GetPosition(),color:a.color,isPlayer:b,lifetime:b?90:5})}function e(){p=0,q=[0,0],r=[0,0],s=Date.now(),t=0}function f(){if(!DEBUG_WAVE){var a=JSON.parse(localStorage.getItem(E))||[];a[D]?a[D]+=p:a[D]=p,localStorage.setItem(E,JSON.stringify(a));for(var b=JSON.parse(localStorage.getItem(F))||[0,0],c=0;2>c;++c)b[c]+=q[c];localStorage.setItem(F,JSON.stringify(b));for(var d=JSON.parse(localStorage.getItem(G))||[0,0],c=0;2>c;++c)d[c]+=r[c];localStorage.setItem(G,JSON.stringify(d));var e=JSON.parse(localStorage.getItem(H))||[];console.log(t,s),e[D]?e[D].push(Date.now()-s-t):e[D]=[Date.now()-s-t],localStorage.setItem(H,JSON.stringify(e)),"function"==typeof enemyStoreStat&&enemyStoreStat(w,D,o,x)}}function g(a){var b=a.GetFixtureA().GetBody().GetUserData(),c=a.GetFixtureB().GetBody().GetUserData();null!==b&&null!==c&&a.SetEnabled(!1)}function h(a){var b=a.GetFixtureA().GetBody().GetUserData(),c=a.GetFixtureB().GetBody().GetUserData();if(null!==b&&null!==c)if(b.type===TYPE_ENEMY&&c.type===TYPE_PLAYER||b.type===TYPE_PLAYER&&c.type===TYPE_ENEMY){var d=b.type===TYPE_PLAYER?b:c,e=b.type===TYPE_PLAYER?c:b;d.isInvincible()||d.isDestroyed()||(B--,0>=B?setTimeout(k,4e3):setTimeout(l,4e3),d.body.SetLinearVelocity(new b2Vec2(0,0)),d.destroy(!0),p++,e.parent?e.parent.kills++:e.kills++)}else if(b.type===TYPE_PLAYER_BULLET&&c.type===TYPE_ENEMY||b.type===TYPE_ENEMY&&c.type===TYPE_PLAYER_BULLET){C+=b.scoreOnDestroy+c.scoreOnDestroy,b.justHit=!0,c.justHit=!0,(b.lifetime<0||c.lifetime<0)&&o.kills++;for(var f=!1,g=0;g<b.onHitAction.length;++g)f|=b.onHitAction[g].call(b,K,L,o,v,w);f||b.destroy(!0),f=!1;for(var g=0;g<c.onHitAction.length;++g)f|=c.onHitAction[g].call(c,K,L,o,v,w);f||c.destroy(!0)}else if(b.type===TYPE_PLAYER&&c.type===TYPE_POWERUP||b.type===TYPE_POWERUP&&c.type===TYPE_PLAYER){var d=b.type===TYPE_PLAYER?b:c,h=b.type===TYPE_POWERUP?b:c;if(!d.destroyed){r[h.puType]++;var i=h.powerup(K,L,o,v,w);if("string"==typeof i){var j=i.match(/(lives|score|wave)\+(\d+)/);if(j)switch(j[1]){case"lives":B+=parseInt(j[2]);break;case"score":C+=parseInt(j[2]);break;case"wave":D+=parseInt(j[2])}}h.destroy(!0)}}}function i(){var a=!0;$.each(w,function(){this.preventNextWave&&(a=!1)}),a&&(f(),e(),D++,0===D%5&&B++,w=generateWave(w,D,o,x),x=w.slice())}function j(){if(!DEBUG_WAVE&&Math.random()<.05/FPS){var a,b,c=randIntBetween(0,1);switch(0===c&&N>C&&(c=1),q[c]++,c){case 0:a={h:0,s:1,l:1,a:1},b=function(){return"lives+1"},N+=200;break;case 1:a={h:180,s:1,l:.5,a:1},b=function(a,b,c){return c.invincibleTimer=6*FPS,!0}}y.push(createPowerup(randomLocation(-3,3,-3,3),randIntBetween(5*FPS,8*FPS),a,c,b))}}function k(){f(),J=!1,N=0,world=null,o=null,v=[],w=[],x=[];var a=HiScore.saveHiScore(D,C);B=5,C=0,D=1,HiScore.showHiScore(a)}function l(){o.revive()}function m(){var a=$(document),b=$(window),c=$("#game-scene");a.keydown(function(a){return K[a.which]=!0,80===a.which&&(I=!I,I?u=Date.now():t+=Date.now()-u,console.log(t)),!1}),a.keyup(function(a){return delete K[a.which],!1}),a.mousedown(function(a){return L[a.which]=!0,L.position={x:(a.pageX-c.offset().left-300)/100,y:-(a.pageY-c.offset().top-300)/100},!1}),b.mouseup(function(a){return delete L[a.which],!1}),b.mousemove(function(a){return L.position={x:(a.pageX-c.offset().left-300)/100,y:-(a.pageY-c.offset().top-300)/100},!1})}function n(){$(".scene").hide(),$("#game-scene").show(),world=new b2World(new b2Vec2(0,0));var a=new b2ContactListener;a.PreSolve=g,a.BeginContact=h,world.SetContactListener(a),addEdgeShape(world,new b2Vec2(-3,-3),new b2Vec2(3,-3),{restitution:1}),addEdgeShape(world,new b2Vec2(-3,3),new b2Vec2(3,3),{restitution:1}),addEdgeShape(world,new b2Vec2(-3,3),new b2Vec2(-3,-3),{restitution:1}),addEdgeShape(world,new b2Vec2(3,3),new b2Vec2(3,-3),{restitution:1}),o=createPlayer(),m(),e(),J=!0,w=generateWave(w,D,o,x),x=w.slice(),b()}var o,p,q,r,s,t,u,v=[],w=[],x=[],y=[],z=[],A=[],B=5,C=0,D=1,E="sq_killed_in_wave_count",F="sq_powerup_generated",G="sq_powerup_taken",H="sq_time_taken",I=!1,J=!1;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/FPS)}}();var K={},L={},M=!1,N=0;$(document).ready(function(){DEBUG_WAVE&&(B=99999,D=DEBUG_WAVE,n()),$("#start").click(function(){n()}),$("#hiscore").click(HiScore.showHiScore)}),window.onbeforeunload=function(){return J&&!DEBUG_WAVE?"Are you sure to quit? Your progress will be lost.":void 0}}();