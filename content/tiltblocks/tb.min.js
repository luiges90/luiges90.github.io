"use strict";function getLevelString(a){return Math.floor(a/10)+1+"-"+(a%10+1)}function clearBoard(){board=[],bottomBoard=[];for(var a=0;BOARD_SIZE>a;++a){board[a]=[],bottomBoard[a]=[];for(var b=0;BOARD_SIZE>b;++b)board[a][b]=".",bottomBoard[a][b]="."}$(".inBoard").fadeOut(function(){$(this).remove()})}function initialize(){clearBoard(),codeDivs=[],$(".palette").each(function(){codeDivs[$(this).data("code")]=this})}function createLevelSelectScene(){for(var a=0;10>a;++a)for(var b=0;10>b;++b){var c=$("<div>");c.addClass("level").data("level",10*a+b),c.css("left",60*b).css("top",50*a),c.html(a+1+"-"+(b+1)),$("#level-select-scene .levels").append(c)}}function getSaveCode(a){for(var b="",c=0;c<a.length;++c)for(var d=0;d<a.length;++d)b+=a[c][d];var e=$("#level-editor-scene .panel .step-limit").val();return e.length<2&&(e="0"+e),b+=e}function createLevelEditorActions(){function a(){board=$.extend(!0,[],b),updateBoardFromData("#level-editor-scene .board"),$("#level-editor-scene .panel.playing").hide(),$("#level-editor-scene .panel.editing").show(),$(".popup").fadeOut(),$(".popup-bg").fadeOut(),$("#popup-layer").fadeOut(),state=STATE_MAIN_MENU}var b,c=$("#level-editor-scene .board");c.mousedown(function(a){c.on("mousemove",function(b){if(state==STATE_MAIN_MENU){var d=b.pageX,e=b.pageY;"undefined"==typeof d&&(d=a.pageX),"undefined"==typeof e&&(e=a.pageY);var f=Math.floor((d-c.offset().left)/SQUARE_SIZE),g=Math.floor((e-c.offset().top)/SQUARE_SIZE),h=String($(".palette.active").data("code"));"undefined"===h&&(h="."),board[g][f]!=h&&(board[g][f]=h,$("#level-editor-scene .inBoard.r"+g+"c"+f).remove(),$(codeDivs[h]).clone().removeClass("palette").removeClass("active").addClass("inBoard").addClass("r"+g+"c"+f).offset({top:SQUARE_SIZE*g,left:SQUARE_SIZE*f}).appendTo("#level-editor-scene .board"))}}).mousemove()}),$(window).mouseup(function(){$("#level-editor-scene .board").off("mousemove")}),$(".palette").click(function(){$(".palette").removeClass("active"),$(this).addClass("active")}),$("#level-editor-scene .panel .save").click(function(){var a=getSaveCode(board);$(".editor.save .level-code").val(a),$(".editor.save").fadeIn()}),$("#level-editor-scene .panel .load").click(function(){$(".editor.load").fadeIn()}),$("#level-editor-scene .load.popup .load-level").click(function(){var a=$("#level-editor-scene .load.popup .level-code").val();loadLevelFromString(a,"#level-editor-scene .board"),$("#level-editor-scene .steps .step-limit").val(step),$(".arrow").removeClass("lastDir"),state=STATE_MAIN_MENU}),$("#level-editor-scene .save-load-ok").click(function(){$(".popup").fadeOut(),$(".popup-bg").fadeOut()}),$(".popup .ok").click(a),$("#level-editor-scene .panel .back").click(a),$("#level-editor-scene .panel .play").click(function(){b=$.extend(!0,[],board),stepLimit=$("#level-editor-scene .panel.editing .step-limit").val(),step=stepLimit,$("#level-editor-scene .panel.playing").show(),$("#level-editor-scene .panel.editing").hide(),$("#level-editor-scene .panel.playing .steps .content").html(step+"/"+stepLimit),$(".arrow").removeClass("lastDir"),$("#level-editor-scene .panel.playing .steps .content").removeClass("warning"),state=STATE_READY})}function updateBoardFromData(a){$(".inBoard").remove();for(var b=0;b<board.length;++b)for(var c=0;c<board.length;++c)"undefined"!=typeof codeDivs[board[b][c]]&&$(codeDivs[board[b][c]]).clone().removeClass("palette").addClass("inBoard").addClass("r"+b+"c"+c).offset({top:SQUARE_SIZE*b,left:SQUARE_SIZE*c}).css("position","absolute").appendTo(a),bottomBoard[b][c]="."}function loadLevelFromString(a,b){a=a.replace(/\s/g,"");for(var c=0;BOARD_SIZE*BOARD_SIZE>c;++c)board[Math.floor(c/BOARD_SIZE)][c%BOARD_SIZE]=a.charAt(c);stepLimit=parseInt(a.slice(-2),10),step=stepLimit,updateBoardFromData(b)}function setupTipPopup(a,b,c,d){state=STATE_TIP,$(".tip-main").html(a),$(".tip-popup").css("left",$("#game-scene").offset().left+b).css("top",$("#game-scene").offset().top+c).show().one("click",function(){return $(".tip-popup").fadeOut(function(){d?d():state=STATE_READY}),!1})}function loadLevel(a){state=STATE_LOADING,$.ajax({url:"levels/"+getLevelString(a)+".txt",dataType:"text",success:function(b){switch(loadLevelFromString(b,"#game-scene .board"),$("#game-scene .level .content").html(getLevelString(a)),$("#game-scene .steps .content").html(step+"/"+stepLimit),$(".arrow").removeClass("lastDir"),$("#game-scene .steps .content").removeClass("warning"),level=a,level>furthestLevel&&(furthestLevel=level),furthestLevel){case 0:setupTipPopup("These are blocks. Eliminate them by putting them together.",150,340,function(){setupTipPopup("By clicking these arrows, you move blocks all the way until they hit something.",500,300)});break;case 10:setupTipPopup("These are stones. They do not eliminate and need not be eliminated.",200,340);break;case 20:setupTipPopup("These are rainbow blocks. They eliminate with any other colored blocks.",400,390);break;case 30:setupTipPopup("These are arrows. They only allow blocks moving at its direction.",300,390);break;case 40:setupTipPopup("These are stickies. Blocks going onto them will be stopped and become unmovable.",300,340);break;case 50:setupTipPopup("These are gates. They open up when blocks land on switches of the same color.",300,390,function(){setupTipPopup("These are switches, used to open gates of the same color.",400,120)});break;case 60:setupTipPopup("These are moving walls, which moves by a square according to its direction as you move.",150,320);break;case 70:setupTipPopup("These are no-match area. Any blocks moving onto them will not be eliminated.",0,370);break;case 80:setupTipPopup("These are wraps, which brings any blocks to another same-colored wraps.",400,140);break;default:state=STATE_READY}},error:function(){window.alert("Too bad! Looks like I am unable to load the level. Check if you are connected to the internet.")}})}function markMoved(a){$(".arrow").removeClass("lastDir"),$(".arrow."+a).addClass("lastDir")}function keyPressed(a){if(state==STATE_READY)switch(a.which){case KEY_UP:makeStep(board,bottomBoard,-1,0,!0),markMoved("up");break;case KEY_DOWN:makeStep(board,bottomBoard,1,0,!0),markMoved("down");break;case KEY_LEFT:makeStep(board,bottomBoard,0,-1,!0),markMoved("left");break;case KEY_RIGHT:makeStep(board,bottomBoard,0,1,!0),markMoved("right")}}function arrowPressed(){if(state==STATE_READY){var a=$(this);a.hasClass("up")?(makeStep(board,bottomBoard,-1,0,!0),markMoved("up")):a.hasClass("down")?(makeStep(board,bottomBoard,1,0,!0),markMoved("down")):a.hasClass("left")?(makeStep(board,bottomBoard,0,-1,!0),markMoved("left")):a.hasClass("right")&&(makeStep(board,bottomBoard,0,1,!0),markMoved("right"))}}function makeStep(a,b,c,d,e){var f=[];canIgnoreOppositeDir=!0,canIgnoreSameDir=!0;do{var g=moveBlocks(a,b,c,d);e&&f.push(g);var h=eliminateBlocks(a,b);e&&f.push(h)}while(h.length>0);var i=moveWalls(a,b);e&&f.push(i);var j=wrapBlocks(a,b),k=[];return h=eliminateBlocks(a,b),e&&(k=h),e?(--step,$("#game-scene .steps .content").html(step+"/"+stepLimit),$("#level-editor-scene .panel.playing .steps .content").html(step+"/"+stepLimit),2>step&&($("#game-scene .steps .content").addClass("warning"),$("#level-editor-scene .panel.playing .steps .content").addClass("warning")),animateBlocks(f,j,k,function(){state=STATE_READY,checkComplete(a,b,!0)||checkFail(a,b)}),void 0):checkComplete(a,b,!1)}function moveBlock(a,b,c,d,e,f){return $.inArray(a[e][f],BOTTOM_LAYER_CODE)>=0&&(b[e][f]=a[e][f]),(c!=e||d!=f)&&(a[e][f]=a[c][d],a[c][d]=b[c][d]),{start:[c,d],end:[e,f]}}function moveBlocks(a,b,c,d){var e=[];if(0>d)for(var f=0;BOARD_SIZE>f;++f)for(var g=0;BOARD_SIZE>g;++g)if($.inArray(a[f][g],MOVABLE_CODE)>=0)if("T"===b[f][g]){var h=moveBlock(a,b,f,g,f,g);h&&e.push(h)}else for(var i=g-1;;--i){if(-1===i||$.inArray(a[f][i],SOLID_CODE)>=0||$.inArray(a[f][i],["W","S","D"])>=0){var h=moveBlock(a,b,f,g,f,i+1);h&&e.push(h);break}if("T"===a[f][i]){var h=moveBlock(a,b,f,g,f,i);h&&e.push(h),canIgnoreOppositeDir=!1;break}"A"===a[f][i]&&(canIgnoreOppositeDir=!1)}if(d>0)for(var f=0;BOARD_SIZE>f;++f)for(var g=BOARD_SIZE-1;g>=0;--g)if($.inArray(a[f][g],MOVABLE_CODE)>=0)if("T"===b[f][g]){var h=moveBlock(a,b,f,g,f,g);h&&e.push(h)}else for(var i=g+1;;++i){if(i===BOARD_SIZE||$.inArray(a[f][i],SOLID_CODE)>=0||$.inArray(a[f][i],["W","S","A"])>=0){var h=moveBlock(a,b,f,g,f,i-1);h&&e.push(h);break}if("T"===a[f][i]){var h=moveBlock(a,b,f,g,f,i);h&&e.push(h),canIgnoreOppositeDir=!1;break}"D"===a[f][i]&&(canIgnoreOppositeDir=!1)}if(0>c)for(var f=0;BOARD_SIZE>f;++f)for(var g=0;BOARD_SIZE>g;++g)if($.inArray(a[g][f],MOVABLE_CODE)>=0)if("T"===b[g][f]){var h=moveBlock(a,b,g,f,g,f);h&&e.push(h)}else for(var i=g-1;;--i){if(-1===i||$.inArray(a[i][f],SOLID_CODE)>=0||$.inArray(a[i][f],["A","S","D"])>=0){var h=moveBlock(a,b,g,f,i+1,f);h&&e.push(h);break}if("T"===a[i][f]){var h=moveBlock(a,b,g,f,i,f);h&&e.push(h),canIgnoreOppositeDir=!1;break}"W"===a[i][f]&&(canIgnoreOppositeDir=!1)}if(c>0)for(var f=0;BOARD_SIZE>f;++f)for(var g=BOARD_SIZE-1;g>=0;--g)if($.inArray(a[g][f],MOVABLE_CODE)>=0)if("T"===b[g][f]){var h=moveBlock(a,b,g,f,g,f);h&&e.push(h)}else for(var i=g+1;;++i){if(i===BOARD_SIZE||$.inArray(a[i][f],SOLID_CODE)>=0||$.inArray(a[i][f],["W","A","D"])>=0){var h=moveBlock(a,b,g,f,i-1,f);h&&e.push(h);break}if("T"===a[i][f]){var h=moveBlock(a,b,g,f,i,f);h&&e.push(h),canIgnoreOppositeDir=!1;break}"S"===a[i][f]&&(canIgnoreOppositeDir=!1)}for(var f=0;BOARD_SIZE>f;++f)for(var g=0;BOARD_SIZE>g;++g)if($.inArray(a[f][g],GATE_CODE)>=0){var h=moveBlock(a,b,f,g,f,g);h&&e.push(h)}return e}function moveWalls(a,b){for(var c=[],d=0;BOARD_SIZE>d;++d)for(var e=0;BOARD_SIZE>e;++e)if("F"===a[d][e])if(canIgnoreSameDir=!1,d>0&&$.inArray(a[d-1][e],SOLID_CODE)<0){var f=moveBlock(a,b,d,e,d-1,e);canIgnoreOppositeDir=!1,f&&c.push(f)}else $.inArray(a[d+1][e],SOLID_CODE)<0&&(a[d][e]="V");for(var d=BOARD_SIZE-1;d>=0;--d)for(var e=0;BOARD_SIZE>e;++e)if("V"===a[d][e])if(canIgnoreSameDir=!1,BOARD_SIZE-1>d&&$.inArray(a[d+1][e],SOLID_CODE)<0){var f=moveBlock(a,b,d,e,d+1,e);canIgnoreOppositeDir=!1,f&&c.push(f)}else if($.inArray(a[d-1][e],SOLID_CODE)<0){a[d][e]="F";var f=moveBlock(a,b,d,e,d-1,e);f&&c.push(f)}for(var d=0;BOARD_SIZE>d;++d)for(var e=0;BOARD_SIZE>e;++e)if("C"===a[d][e])if(canIgnoreSameDir=!1,e>0&&$.inArray(a[d][e-1],SOLID_CODE)<0){var f=moveBlock(a,b,d,e,d,e-1);canIgnoreOppositeDir=!1,f&&c.push(f)}else $.inArray(a[d][e+1],SOLID_CODE)<0&&(a[d][e]="B");for(var d=0;BOARD_SIZE>d;++d)for(var e=BOARD_SIZE-1;e>=0;--e)if("B"===a[d][e])if(canIgnoreSameDir=!1,BOARD_SIZE-1>e&&$.inArray(a[d][e+1],SOLID_CODE)<0){var f=moveBlock(a,b,d,e,d,e+1);canIgnoreOppositeDir=!1,f&&c.push(f)}else if($.inArray(a[d][e-1],SOLID_CODE)<0){a[d][e]="C";var f=moveBlock(a,b,d,e,d,e-1);f&&c.push(f)}return c}function eliminateBlocks(a,b){for(var c=[],d=0;BOARD_SIZE>d;++d)for(var e=0;BOARD_SIZE>e;++e){if($.inArray(a[d][e],BLOCK_CODE)>=0&&"N"!=b[d][e]){a[d][e];for(var f=[],g=0;BOARD_SIZE>g;++g){f[g]=[];for(var h=0;BOARD_SIZE>h;++h)f[g][h]=!1}var i=[];if(function k(c,d){c=parseInt(c,10),d=parseInt(d,10),f[c][d]=!0,"N"!==b[c][d]&&(i.push([c,d]),"9"===a[c][d]&&(c>0&&$.inArray(a[c-1][d],BLOCK_CODE)>=0&&!f[c-1][d]&&k(c-1,d),BOARD_SIZE-1>c&&$.inArray(a[c+1][d],BLOCK_CODE)>=0&&!f[c+1][d]&&k(c+1,d),d>0&&$.inArray(a[c][d-1],BLOCK_CODE)>=0&&!f[c][d-1]&&k(c,d-1),BOARD_SIZE-1>d&&$.inArray(a[c][d+1],BLOCK_CODE)>=0&&!f[c][d+1]&&k(c,d+1)),c>0&&!f[c-1][d]&&(a[c-1][d]===a[c][d]||"9"===a[c-1][d])&&k(c-1,d),BOARD_SIZE-1>c&&!f[c+1][d]&&(a[c+1][d]===a[c][d]||"9"===a[c+1][d])&&k(c+1,d),d>0&&!f[c][d-1]&&(a[c][d-1]===a[c][d]||"9"===a[c][d-1])&&k(c,d-1),BOARD_SIZE-1>d&&!f[c][d+1]&&(a[c][d+1]===a[c][d]||"9"===a[c][d+1])&&k(c,d+1))}(d,e),i.length>1){canIgnoreOppositeDir=!1;for(var g in i)a[i[g][0]][i[g][1]]=b[i[g][0]][i[g][1]],c.push(i[g])}}if($.inArray(a[d][e],MOVABLE_CODE)>=0){var j=function(f,g){if(b[d][e]===f)for(var h=0;BOARD_SIZE>h;++h)for(var i=0;BOARD_SIZE>i;++i)a[h][i]===g&&(a[h][i]=".",c.push([h,i]),canIgnoreOppositeDir=!1)};j("H","U"),j("J","I"),j("K","O"),j("L","P")}}return c}function getWrapLocation(a,b,c,d){for(var e=c;BOARD_SIZE>e;++e)for(var f=e===c?d:0;BOARD_SIZE>f;++f)if(a[e][f]===b[c][d])return{r:e,c:f};for(var e=0;c>=e;++e)for(var f=0;(e===c?d:BOARD_SIZE)>f;++f)if(a[e][f]===b[c][d])return{r:e,c:f};return null}function wrapBlocks(a,b){for(var c=[],d=[],e=0;BOARD_SIZE>e;++e)for(var f=0;BOARD_SIZE>f;++f)if($.inArray(b[e][f],WRAP_CODE)>=0&&$.inArray(a[e][f],MOVABLE_CODE)>=0){canIgnoreOppositeDir=!1,canIgnoreSameDir=!1;var g=!1;for(var h in d)d[h].r===e&&d[h].c===f&&(g=!0);if(!g){var i=getWrapLocation(a,b,e,f);if(null!=i){var j=moveBlock(a,b,e,f,i.r,i.c);j&&c.push(j),d.push(i)}}}return c}function animateBlocks(a,b,c,d){function e(){if(b.length<=0)d();else for(var a in b){var e=b[a].start,f=b[a].end;$(".r"+e[0]+"c"+e[1]).not(BOTTOM_LAYER_CLASSES).fadeOut(WRAPPING_SPEED).animate({top:SQUARE_SIZE*f[0],left:SQUARE_SIZE*f[1]},0,"linear").fadeIn(WRAPPING_SPEED).removeClass("r"+e[0]+"c"+e[1]).addClass("r"+f[0]+"c"+f[1]),setTimeout(function(){var a=!1;if(c.length>0)for(var b in c)a=!0,$(".r"+c[b][0]+"c"+c[b][1]).not(BOTTOM_LAYER_CLASSES).fadeOut(ELIMINATE_SPEED,function(){$(this).remove()});a?setTimeout(d,ELIMINATE_SPEED):d()},2*WRAPPING_SPEED)}}state=STATE_ANIMATING;for(var f=0,g=0;g<a.length-1;g+=2){var h=-1;for(var i in a[g]){var j=a[g][i].start,k=a[g][i].end,l=Math.abs(j[0]-k[0])+Math.abs(j[1]-k[1]);l>h&&(h=l)}for(var i in a[g]){var j=a[g][i].start,k=a[g][i].end,l=Math.abs(j[0]-k[0])+Math.abs(j[1]-k[1]);$(".r"+j[0]+"c"+j[1]).not(BOTTOM_LAYER_CLASSES).animate({top:SQUARE_SIZE*k[0],left:SQUARE_SIZE*k[1]},l*MOVING_SPEED,"linear").removeClass("r"+j[0]+"c"+j[1]).addClass("r"+k[0]+"c"+k[1]).delay(h*MOVING_SPEED-l*MOVING_SPEED)}f+=h*MOVING_SPEED;for(var i in a[g+1])$(".r"+a[g+1][i][0]+"c"+a[g+1][i][1]).not(BOTTOM_LAYER_CLASSES).fadeOut(ELIMINATE_SPEED,function(){$(this).remove()});if(a[g+1].length>0){f+=ELIMINATE_SPEED;for(var i in a[g]){var k=a[g][i].end;$(".r"+k[0]+"c"+k[1]).delay(ELIMINATE_SPEED)}}}setTimeout(function(){var b=a[a.length-1];if(b.length<=0)e();else{for(var c in b){var d=b[c].start,f=b[c].end;$(".r"+d[0]+"c"+d[1]).not(BOTTOM_LAYER_CLASSES).animate({top:SQUARE_SIZE*f[0],left:SQUARE_SIZE*f[1]},MOVING_SPEED,"linear").removeClass("r"+d[0]+"c"+d[1]).addClass("r"+f[0]+"c"+f[1])}setTimeout(e,MOVING_SPEED)}},f)}function checkComplete(a,b,c){for(var d=!0,e=!1,f=0;BOARD_SIZE>f;++f)for(var g=0;BOARD_SIZE>g;++g)$.inArray(a[f][g],BLOCK_CODE)>=0&&(d=!1);return d&&c&&(state=STATE_CLEARED,inEditor||(level>=furthestLevel&&(furthestLevel++,e=!0),localStorage.setItem(PROGRESS_KEY,furthestLevel)),!inEditor&&level>=TOTAL_LEVELS-1&&e?($(".scene").fadeOut(4e3),setTimeout(function(){$(".game-cleared").fadeIn(3e3),$(".game-cleared .home").one("click",function(){$("#popup-layer").fadeOut(),$("#game-cleared").fadeOut(),$("#main-menu-scene").fadeIn()})},4e3)):($(".level-cleared .content").html("Steps remain: "+step),$("#popup-layer").css("background-color","transparent").fadeIn(),$(".level-cleared").fadeIn(),inEditor?($(".popup .buttons.main").hide(),$(".popup .buttons.editor").show()):($(".popup .buttons.editor").hide(),$(".popup .buttons.main").show()),inEditor||$(".next").one("click",function(){level++,loadLevel(level),$("#popup-layer").fadeOut(),$(".level-cleared").fadeOut()}))),d}function checkFail(){if(state!==STATE_CLEARED){var a=!1;return 0>=step&&(a="Too many steps!"),a&&($(".level-failed .content").html(a),$("#popup-layer").css("background-color","#000").fadeIn(),inEditor?($(".popup .buttons.main").hide(),$(".popup .buttons.editor").show()):($(".popup .buttons.editor").hide(),$(".popup .buttons.main").show()),$(".level-failed").fadeIn(),state=STATE_FAILED),a}}function solve(){function a(b,c,d,e,f,g,h){var i,j=!1;switch(g.push(f),h.push($.extend(!0,[],b)),f){case"↑":i=makeStep(b,c,-1,0);break;case"←":i=makeStep(b,c,0,-1);break;case"↓":i=makeStep(b,c,1,0);break;case"→":i=makeStep(b,c,0,1)}var k=canIgnoreOppositeDir,l=canIgnoreSameDir;if(i)return g;if(e>=d)return g.pop(),h.pop(),!1;if(isImpossible(b,c)||duplicatedBoard(b,h))return g.pop(),h.pop(),null;var m=!0;return"↑"==f&&l||"↓"==f&&k||(j=a($.extend(!0,[],b),$.extend(!0,[],c),d,e+1,"↑",g,h),null!==j&&(m=!1),!j)?j||"←"==f&&l||"→"==f&&k||(j=a($.extend(!0,[],b),$.extend(!0,[],c),d,e+1,"←",g,h),null!==j&&(m=!1),!j)?j||"↓"==f&&l||"↑"==f&&k||(j=a($.extend(!0,[],b),$.extend(!0,[],c),d,e+1,"↓",g,h),null!==j&&(m=!1),!j)?j||"→"==f&&l||"←"==f&&k||(j=a($.extend(!0,[],b),$.extend(!0,[],c),d,e+1,"→",g,h),null!==j&&(m=!1),!j)?(g.pop(),h.pop(),m?null:!1):j:j:j:j}function b(b){var c=!1,d=!0;return c=a($.extend(!0,[],board),$.extend(!0,[],bottomBoard),b,1,"↑",[],[]),null!==c&&(d=!1),c?c:(c||(c=a($.extend(!0,[],board),$.extend(!0,[],bottomBoard),b,1,"←",[],[])),null!==c&&(d=!1),c?c:(c||(c=a($.extend(!0,[],board),$.extend(!0,[],bottomBoard),b,1,"↓",[],[])),null!==c&&(d=!1),c?c:(c||(c=a($.extend(!0,[],board),$.extend(!0,[],bottomBoard),b,1,"→",[],[])),null!==c&&(d=!1),c?c:d?null:!1)))}var c;console.log(getSaveCode(board)),inEditor&&(stepLimit=$("#level-editor-scene .panel .step-limit").val()),console.log("Trying to solve the board within "+stepLimit+" steps.");for(var d=1;stepLimit>=d&&!c&&(c=b(d),console.log("Steps spent: "+d),null!==c);++d);return null===c?console.log("This level is definitely impossible. You may need to tweak your level."):c===!1?console.log("Unable to solve this level within "+stepLimit+" steps. Maybe raise your step limit?"):console.log("Solution: "+c),c}function duplicatedBoard(a,b){for(var c=b.length-1;c>=0;--c){var d=!0;for(var e in b[c])for(var f in b[c][e])b[c][e][f]!=a[e][f]&&(d=!1);if(d)return!0}return!1}function isImpossible(a,b){for(var c=[],d=0;BOARD_SIZE>d;++d)for(var e=0;BOARD_SIZE>e;++e)"undefined"==typeof c[a[d][e]]?c[a[d][e]]=[{r:d,c:e}]:c[a[d][e]].push({r:d,c:e});if("function"==typeof extraImpossible&&extraImpossible(a,b,c))return!0;for(var d in c)if($.inArray(d,["1","2","3","4"])>=0&&1===c[d].length&&"undefined"==typeof c["9"])return!0;if("undefined"!=typeof c["9"]&&1===c["9"].length&&"undefined"==typeof c["1"]&&"undefined"==typeof c["2"]&&"undefined"==typeof c["3"]&&"undefined"==typeof c["4"])return!0;for(var d in c)if($.inArray(d,["1","2","3","4"])>=0){var f=0;for(var e in c[d])"T"===b[c[d][e].r][c[d][e].c]&&f++;if(f>(c[d].length+("undefined"==typeof c["9"]?0:c["9"].length))/2)return!0}return!1}var BOARD_SIZE=12,SQUARE_SIZE=48,TOTAL_LEVELS=100,STATE_LOADING=0,STATE_READY=1,STATE_ANIMATING=2,STATE_CLEARED=3,STATE_FAILED=4,STATE_MAIN_MENU=5,STATE_TIP=6,inEditor=!1,KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40,state,step,stepLimit,level=0,BLOCK_CODE=["1","2","3","4","9"],MOVABLE_CODE=BLOCK_CODE.concat(["0"]),GATE_CODE=["U","I","O","P"],WRAP_CODE=["Q","Z","E","R"],SOLID_CODE=MOVABLE_CODE.concat(GATE_CODE).concat(["X","F","C","V","B"]),BOTTOM_LAYER_CODE=["W","A","S","D","T","H","J","K","L","N","Q","Z","E","R"],BOTTOM_LAYER_CLASSES=".leftArrow, .rightArrow, .upArrow, .downArrow, .sticky, .redTrigger, .greenTrigger, .blueTrigger, .yellowTrigger, .noMatch, .redWrap, .greenWrap, .blueWrap, .yellowWrap",PROGRESS_KEY="tb_level",furthestLevel=0,storedLevel=0,canIgnoreOppositeDir=!0,canIgnoreSameDir=!0;$(document).ready(function(){state=STATE_MAIN_MENU,furthestLevel=localStorage.getItem(PROGRESS_KEY),furthestLevel=parseInt(furthestLevel,10),isNaN(furthestLevel)&&(furthestLevel=0),level=furthestLevel,initialize(),createLevelSelectScene(),$(document).keyup(keyPressed),$(".arrow").mousedown(arrowPressed),$(".scene").hide(),$("#main-menu-scene").show(),$("#main-menu-scene .start").click(function(){$(".scene").fadeOut(),$("#game-scene").fadeIn(),$("#main-menu-scene #progress-clear-alert").hide(),furthestLevel>TOTAL_LEVELS?loadLevel(0):loadLevel(furthestLevel)}),$("#main-menu-scene .level-select").click(function(){$("#level-select-scene .level").each(function(){$(this).data("level")<furthestLevel?$(this).css("background-color","#0F0").addClass("cleared-level open-level"):$(this).data("level")===furthestLevel?$(this).css("background-color","#FF0").addClass("current-level open-level"):$(this).css("background-color","#CCC").addClass("locked-level")}),$(".scene").fadeOut(),$("#level-select-scene").fadeIn()}),$("#level-select-scene").on("click",".level.open-level",function(){$(".scene").fadeOut(),$("#game-scene").fadeIn(),level=$(this).data("level"),loadLevel(level)}),$("#main-menu-scene .clear-progress").click(function(){level>0&&(storedLevel=furthestLevel),localStorage.removeItem(PROGRESS_KEY),$("#main-menu-scene #progress-clear-alert").html('Progress cleared. <a href="#">Ouch! Undo my clear!!</a>').show(),$("#main-menu-scene #progress-clear-alert a").click(function(a){a.preventDefault(),furthestLevel=storedLevel,localStorage.setItem(PROGRESS_KEY,storedLevel),$("#main-menu-scene #progress-clear-alert").html("OK, your progress has been restored. :)").delay(5e3).fadeOut()}),level=0,furthestLevel=0}),$("#level-select-scene .left").click(function(){$(".scene").fadeOut(),$("#main-menu-scene").fadeIn()}),$("#main-menu-scene .level-editor").click(function(){$(".scene").fadeOut(),$("#level-editor-scene .panel.playing").hide(),$("#level-editor-scene").fadeIn(function(){$(".palette-table").data("jsp").reinitialise()}),inEditor=!0}),createLevelEditorActions(),$(".home").click(function(){$(".next").off("click"),$("#popup-layer").fadeOut(),$(".popup").fadeOut(),$(".popup-bg").fadeOut(),$(".scene").fadeOut(),$("#main-menu-scene").fadeIn(),$(".tip-popup").fadeOut(),state=STATE_MAIN_MENU,clearBoard(),inEditor=!1}),$(".retry").click(function(){$(".next").off("click"),loadLevel(level),$("#popup-layer").fadeOut(),$(".popup").fadeOut(),$(".popup-bg").fadeOut()}),$(".palette-table").jScrollPane().hover(function(){$(".palette-table .jspVerticalBar").animate({opacity:1},200)},function(){$(".palette-table .jspVerticalBar").animate({opacity:0},200)}),$(document).on("keyup",function(a){13===a.which?$(".level-cleared").is(":visible")?$(".next").click():$(".level-failed").is(":visible")&&$(".retry").click():82===a.which&&$(".retry").click()})});var board,bottomBoard,codeDivs,step,stepLimit,MOVING_SPEED=100,WRAPPING_SPEED=400,ELIMINATE_SPEED=400;